name: Payload Dumper Performance Comparison

on:
  workflow_dispatch:

jobs:
  benchmark:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        input_type: [zip, raw]

    runs-on: ${{ matrix.os }}
    name: ${{ matrix.os }} - ${{ matrix.input_type }}

    steps:
      - name: Checkout repo (for workflow scripts)
        uses: actions/checkout@v4

      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y unzip wget

      - name: Install dependencies (Windows)
        if: matrix.os == 'windows-latest'
        run: choco install wget unzip -y

      - name: Install hyperfine
        run: cargo install hyperfine

      - name: Prepare directories
        shell: bash
        run: mkdir -p main old output_main output_old ota

      - name: Determine macOS architecture
        if: matrix.os == 'macos-latest'
        id: arch
        run: |
          ARCH=$(uname -m)
          echo "arch=$ARCH" >> $GITHUB_OUTPUT

      - name: Download prebuilt binaries
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            MAIN_URL="https://github.com/KaluaBilla/payload-dumper-rust/releases/download/payload-dumper-rust-v0.7.7/payload_dumper-linux-x86_64.zip"
            OLD_URL="https://github.com/rhythmcache/payload-dumper-rust/releases/download/payload-dumper-rust-v0.7.5/payload_dumper-linux-x86_64.zip"
          elif [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            MAIN_URL="https://github.com/KaluaBilla/payload-dumper-rust/releases/download/payload-dumper-rust-v0.7.7/payload_dumper-windows-x86_64.zip"
            OLD_URL="https://github.com/rhythmcache/payload-dumper-rust/releases/download/payload-dumper-rust-v0.7.4/payload_dumper-windows-x86_64.zip"
          else
            if [[ "${{ steps.arch.outputs.arch }}" == "arm64" || "${{ steps.arch.outputs.arch }}" == "aarch64" ]]; then
              MAIN_URL="https://github.com/KaluaBilla/payload-dumper-rust/releases/download/payload-dumper-rust-v0.7.7/payload_dumper-macos-aarch64.zip"
              OLD_URL="https://github.com/rhythmcache/payload-dumper-rust/releases/download/payload-dumper-rust-v0.7.5/payload_dumper-macos-aarch64.zip"
            else
              MAIN_URL="https://github.com/KaluaBilla/payload-dumper-rust/releases/download/payload-dumper-rust-v0.7.7/payload_dumper-macos-x86_64.zip"
              OLD_URL="https://github.com/rhythmcache/payload-dumper-rust/releases/download/payload-dumper-rust-v0.7.5/payload_dumper-macos-x86_64.zip"
            fi
          fi

          echo "Downloading binaries..."
          wget -q -O main.zip "$MAIN_URL"
          wget -q -O old.zip "$OLD_URL"

          unzip -o main.zip -d main
          unzip -o old.zip -d old
          chmod +x main/payload_dumper* old/payload_dumper* || true

      - name: Download OTA package
        shell: bash
        run: |
          cd ota
          wget -q -O ota.zip https://dl.google.com/dl/android/aosp/akita-ota-ud2a.231203.054-6b2d9ff8.zip

      - name: Extract payload.bin (for raw input test)
        if: matrix.input_type == 'raw'
        shell: bash
        run: |
          cd ota
          unzip -j ota.zip payload.bin

      - name: Run benchmark
        shell: bash
        run: |
          WORK_DIR=$(pwd)
          cd ota
          
          if [ "${{ matrix.input_type }}" == "zip" ]; then
            INPUT="ota.zip"
          else
            INPUT="payload.bin"
          fi

          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            MAIN_BIN="$WORK_DIR/main/payload_dumper.exe"
            OLD_BIN="$WORK_DIR/old/payload_dumper.exe"
            OUTPUT_MAIN="$WORK_DIR/output_main"
            OUTPUT_OLD="$WORK_DIR/output_old"
          else
            MAIN_BIN="../main/payload_dumper"
            OLD_BIN="../old/payload_dumper"
            OUTPUT_MAIN="../output_main"
            OUTPUT_OLD="../output_old"
          fi

          hyperfine \
            --warmup 1 \
            --runs 3 \
            --export-json "$WORK_DIR/benchmark_${{ matrix.os }}_${{ matrix.input_type }}.json" \
            --export-markdown "$WORK_DIR/benchmark_${{ matrix.os }}_${{ matrix.input_type }}.md" \
            "$MAIN_BIN --threads 4 --no-verify -o $OUTPUT_MAIN $INPUT" \
            "$OLD_BIN --threads 4 --no-verify -o $OUTPUT_OLD $INPUT"

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-${{ matrix.os }}-${{ matrix.input_type }}
          path: |
            benchmark_*.json
            benchmark_*.md

  summarize:
    needs: benchmark
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: results

      - name: Create summary
        shell: bash
        run: |
          echo "# Payload Dumper Performance Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Comparing **main (v0.7.7)** vs **old (v0.7.5/v0.7.4)** releases of [rhythmcache/payload-dumper-rust](https://github.com/rhythmcache/payload-dumper-rust)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for os in ubuntu-latest macos-latest windows-latest; do
            echo "## $(echo $os | sed 's/-latest//' | tr '[:lower:]' '[:upper:]')" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            for type in zip raw; do
              FILE="results/benchmark-${os}-${type}/benchmark_${os}_${type}.md"
              if [ -f "$FILE" ]; then
                echo "### ${type^^} Input" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                cat "$FILE" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            done
          done

      - name: Upload combined results
        uses: actions/upload-artifact@v4
        with:
          name: all-benchmark-results
          path: results/
